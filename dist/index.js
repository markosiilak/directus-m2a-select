import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as l,ref as n,onMounted as o,watch as i,resolveComponent as a,openBlock as c,createElementBlock as s,createVNode as r,withCtx as d,toDisplayString as u,createTextVNode as p,createElementVNode as f,Fragment as m,renderList as v,createBlock as h}from"vue";const y={class:"m2a-field-selector"},g={key:0,class:"selected-values"},b={key:1},w={class:"drawer-content"},x={class:"item-row"},F={class:"item-label"};var k=l({__name:"interface",props:{value:{},disabled:{type:Boolean},collections:{},placeholder:{},outputFormat:{}},emits:["input"],setup(t,{emit:l}){const k=e(),_=t,C=l,S=n(!1),O=n(""),A=n({}),j=n([]),N=(e,t)=>{const l=A.value[e]||[];return O.value?l.filter((e=>String(e[t]).toLowerCase().includes(O.value.toLowerCase()))):l},V=async e=>{if(e)try{const t=await k.get(`/items/${e}`);A.value[e]=t.data.data}catch(t){console.error(`Error fetching items for ${e}:`,t),A.value[e]=[]}},E=(e,t)=>j.value.some((l=>l.collection===e&&l.item.id===t)),J=(e,t)=>{const l=j.value.findIndex((l=>l.collection===e.collection&&l.item.id===t.id));-1===l?j.value.push({collection:e.collection,outputField:e.outputField,item:t}):j.value.splice(l,1),T()},T=()=>{if(0===j.value.length)return void C("input",null);const e=j.value.map((e=>({collection:e.collection,field:e.outputField,value:e.item[e.outputField],id:e.item.id})));switch(_.outputFormat){case"simple":C("input",JSON.stringify(e.map((e=>e.value))));break;case"ids":C("input",JSON.stringify(e.map((e=>e.id))));break;default:C("input",JSON.stringify(e))}};return o((async()=>{for(const e of _.collections)await V(e.collection);if(_.value)try{const e=JSON.parse(_.value);(Array.isArray(e)?e:[e]).forEach((e=>{var t;if(_.collections.find((t=>t.collection===e.collection))){const l=null==(t=A.value[e.collection])?void 0:t.find((t=>t.id===e.id));l&&j.value.push({collection:e.collection,outputField:e.field,item:l})}}))}catch(e){console.error("Error parsing initial value:",e)}})),i((()=>_.collections),(async e=>{for(const t of e)A.value[t.collection]||await V(t.collection)}),{deep:!0}),i((()=>_.value),(async e=>{var t;if(e){const l=(e=>{if(!e)return[];try{const t="string"==typeof e?JSON.parse(e):e;if(!Array.isArray(t)&&"object"==typeof t)return[t];if(Array.isArray(t)){if(t.length>0&&"string"==typeof t[0])return Object.entries(A.value).flatMap((([e,l])=>{const n=_.collections.find((t=>t.collection===e));return n?l.filter((e=>t.includes(e[n.outputField]))).map((t=>({collection:e,field:n.outputField,value:t[n.outputField],id:t.id}))):[]}));if(t.length>0&&("number"==typeof t[0]||"string"==typeof t[0]))return Object.entries(A.value).flatMap((([e,l])=>{const n=_.collections.find((t=>t.collection===e));return n?l.filter((e=>t.includes(e.id))).map((t=>({collection:e,field:n.outputField,value:t[n.outputField],id:t.id}))):[]}))}return t}catch(e){return console.error("Error processing value:",e),[]}})(e);j.value=[];for(const e of l){if(_.collections.find((t=>t.collection===e.collection))){A.value[e.collection]||await V(e.collection);const l=null==(t=A.value[e.collection])?void 0:t.find((t=>t.id===e.id));l&&j.value.push({collection:e.collection,outputField:e.field,item:l})}}}else j.value=[]}),{immediate:!0}),(e,t)=>{const l=a("v-icon"),n=a("v-button"),o=a("v-input"),i=a("v-checkbox"),k=a("v-list-item-content"),_=a("v-list-item"),C=a("v-list"),A=a("v-drawer");return c(),s("div",y,[r(n,{class:"select-button",disabled:e.disabled,onClick:t[0]||(t[0]=e=>S.value=!0),secondary:""},{default:d((()=>[j.value.length?(c(),s("span",g,u(j.value.map((e=>e.item[e.outputField])).join(", ")),1)):(c(),s("span",b,u(e.placeholder||"Choose items..."),1)),r(l,{name:"arrow_right"})])),_:1},8,["disabled"]),r(A,{modelValue:S.value,"onUpdate:modelValue":t[3]||(t[3]=e=>S.value=e),title:e.placeholder||"Choose items...",onCancel:t[4]||(t[4]=e=>S.value=!1)},{actions:d((()=>[r(n,{secondary:"",onClick:t[1]||(t[1]=e=>S.value=!1)},{default:d((()=>t[5]||(t[5]=[p("Done")]))),_:1})])),default:d((()=>[f("div",w,[r(o,{modelValue:O.value,"onUpdate:modelValue":t[2]||(t[2]=e=>O.value=e),placeholder:"Search...","icon-left":"search",class:"search-input"},null,8,["modelValue"]),r(C,{class:"collection-list"},{default:d((()=>[(c(!0),s(m,null,v(e.collections,(e=>(c(),s(m,{key:e.collection},[(c(!0),s(m,null,v(N(e.collection,e.outputField),(t=>(c(),h(_,{key:`${e.collection}-${t.id}`,clickable:"",active:E(e.collection,t.id),onClick:l=>J(e,t)},{default:d((()=>[r(k,{class:"item-content"},{default:d((()=>[f("div",x,[r(i,{"model-value":E(e.collection,t.id),"onUpdate:modelValue":l=>J(e,t)},null,8,["model-value","onUpdate:modelValue"]),f("span",F,u(t[e.outputField]),1)])])),_:2},1024)])),_:2},1032,["active","onClick"])))),128))],64)))),128))])),_:1})])])),_:1},8,["modelValue","title"])])}}}),_=[],C=[];!function(e,t){if(e&&"undefined"!=typeof document){var l,n=!0===t.prepend?"prepend":"append",o=!0===t.singleTag,i="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(o){var a=_.indexOf(i);-1===a&&(a=_.push(i)-1,C[a]={}),l=C[a]&&C[a][n]?C[a][n]:C[a][n]=c()}else l=c();65279===e.charCodeAt(0)&&(e=e.substring(1)),l.styleSheet?l.styleSheet.cssText+=e:l.appendChild(document.createTextNode(e))}function c(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var l=Object.keys(t.attributes),o=0;o<l.length;o++)e.setAttribute(l[o],t.attributes[l[o]]);var a="prepend"===n?"afterbegin":"beforeend";return i.insertAdjacentElement(a,e),e}}(".m2a-field-selector[data-v-eb2e5293] {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n}\n\n.select-button[data-v-eb2e5293] {\n  width: 100%;\n  justify-content: space-between;\n  text-align: left;\n}\n\n.drawer-content[data-v-eb2e5293] {\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  padding: 12px;\n}\n\n.search-input[data-v-eb2e5293] {\n  margin-bottom: 8px;\n}\n\n.collection-list[data-v-eb2e5293] {\n  flex-grow: 1;\n  overflow-y: auto;\n}\n\n.selected-values[data-v-eb2e5293] {\n  display: block;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  padding-right: 8px;\n}\n\n.collection-header[data-v-eb2e5293] {\n  background-color: var(--background-subdued);\n  font-weight: 600;\n  pointer-events: none;\n  padding: 4px 8px;\n}\n.collection-header [data-v-eb2e5293] .v-list-item-content {\n  font-size: 0.9em;\n  text-transform: uppercase;\n  color: var(--foreground-subdued);\n}\n\n.item-content[data-v-eb2e5293] {\n  padding: 4px 0;\n}\n\n.item-row[data-v-eb2e5293] {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.item-label[data-v-eb2e5293] {\n  flex: 1;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}",{});var S=t({id:"m2a-field-selector",name:"M2A Field Selector",icon:"link",description:"Select items from collections with custom field output",component:((e,t)=>{const l=e.__vccOpts||e;for(const[e,n]of t)l[e]=n;return l})(k,[["__scopeId","data-v-eb2e5293"],["__file","interface.vue"]]),types:["json","alias"],group:"relational",localTypes:["m2a"],options:[{field:"collections",name:"Collections",type:"json",meta:{width:"full",interface:"list",options:{template:"{{collection}} â†’ {{outputField}}",fields:[{field:"collection",name:"Collection",type:"string",meta:{width:"half",interface:"system-collection",options:{includeSystem:!1,allowNone:!1}}},{field:"outputField",name:"Output Field",type:"string",meta:{width:"half",interface:"system-field",options:{collectionField:"collection",allowPrimaryKey:!1}}}]}}},{field:"outputFormat",name:"Output Format",type:"string",meta:{width:"half",interface:"select-dropdown",options:{choices:[{text:"Detailed (with collection and id)",value:"detailed"},{text:"Simple (values only)",value:"simple"},{text:"IDs only",value:"ids"}]},default:"detailed"}},{field:"placeholder",name:"Placeholder",type:"string",meta:{width:"half",interface:"input",options:{placeholder:"Choose an item..."}}}]});export{S as default};
